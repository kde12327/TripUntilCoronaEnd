<!DOCTYPE html>
<html>
  <head>
    <title>Overlays Within Street View</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVG49ILM-LzB5si_emdSYTz4Sejsiknpw&callback=initialize&libraries=&v=weekly"
      defer
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"></script>
    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        left: calc(20% + 20px);
        bottom: 20px;
        height: 300px;
        width: 300px;
        z-index: 2;
      }
      #sidetab {
        float: left;
        height: 100%;
        width: 20%;
      }
      #pano {
        float: left;
        height: 100%;
        width: 80%;
      }
      #course_title {
        height: 60px;
        width: 100%;
        font-size: x-large;
        text-align: center;
        padding: 20px 0 0 0;
        background-color: #97cbff;
      }
      #course_list {
        padding: 10px 0 0 0;
        float: top;
      }
      #course_list li{
        position: relative;
        float: top;
        list-style-type: none;
        height: 40px;
      }
      #course_list li #course_list_item_img{
        margin: 0 0 0 20px; 
        float: left; 
        height: 40px;
      }

      #course_list li:first-child #course_list_item_img svg g #top_line{
        visibility: hidden;
      }

      #course_list li:last-child #course_list_item_img svg g #bottom_line{
        visibility: hidden;
      }

      .course_list_item_img_selected{
        fill: #A4FF8D;
      }

      #course_list li #course_list_item_name{
        float: left; 
        left: 58px;
        text-align: center;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        white-space:nowrap;
      }
      #next_course{
        width: 200px;
        height: 40px;
        position: absolute;
        background-color: #222222;
        right: 60px;
        bottom: 25px;
        z-index: 2;
        color: #666;
        text-align: center;
        font-size: x-large;
        cursor: pointer;
        border-radius: 2px;
        line-height: 40px;
      }
      #course_finish{
        width: 200px;
        height: 40px;
        position: absolute;
        background-color: #222222;
        right: 60px;
        bottom: 25px;
        z-index: 2;
        color: #666;
        text-align: center;
        font-size: x-large;
        cursor: pointer;
        border-radius: 2px;
        line-height: 40px;
      }
      .hidden {
        visibility: hidden;
      }
    </style>
    <script>
      

      function Course() {
        var courseTitle = '<%= data.course_title %>';
        var courseList = eval('<%- JSON.stringify(data.course_list) %>');
        var currentIndex = 0;
        var map = null;
        var panorama = null;

        this.getTitle = function() {
          return courseTitle;
        };
        this.setTitle = function(title) {
          courseTitle = title;
        };
        this.getList = function() {
          return courseList;
        };
        this.setList = function(list) {
          courseList = list;
        };
        this.getIndex = function() {
          return currentIndex;
        };
        this.setIndex = function(i) {
          currentIndex = i;
        };
        this.getMap = function() {
          return map;
        };
        this.setMap = function(m) {
          map = m;
        };this.getPanorama = function() {
          return panorama;
        };
        this.setPanorama = function(p) {
          panorama = p;
        };
        this.nextIndex = function() {
          if(currentIndex != courseList.length - 1){
            currentIndex ++;
            this.panoramaReload();
          }
          this.listRefresh();
        };
        this.listRefresh = function() {
          var $list = $('div#course_list');
          $list.empty();

          $('#next_course').removeClass('hidden');
          $('#course_finish').addClass('hidden');
          if(currentIndex >= courseList.length - 1) {  
            currentIndex = courseList.length - 1;
            $('#next_course').addClass('hidden');
            $('#course_finish').removeClass('hidden');
          }
          courseList.forEach( (e, i) => {
            $list.append(`
              <li>
                <div id="course_list_item_img">
                  <svg width="18" height="40" viewBox="0 0 18 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="group">
                    <line id="bottom_line" x1="9" y1="20" x2="9" y2="40" stroke="#979797" stroke-width="2"/>
                    <line id="top_line" x1="9" x2="9" y2="20" stroke="#979797" stroke-width="2"/>
                    <circle id="outer_ellipse" r="9" transform="matrix(-1 0 0 1 9 20)" fill="#979797"/>
                    <circle id="inner_ellipse" class="${(currentIndex == i)?'course_list_item_img_selected':''}" r="7" transform="matrix(-1 0 0 1 9 20)" fill="#d9d9d9"/>
                    </g>
                  </svg>
                </div>
                <div id="course_list_item_name">${e.courseItemName}</div>
              </li> 
            `)
          });
          
        }
        this.panoramaReload = function(){
          panorama.setPosition(new google.maps.LatLng(courseList[currentIndex].lat, courseList[currentIndex].lng));
        }
      } 

      var course = new Course();

      $(document).ready(() => {
        $('#next_course').on('click', (e) => {
          course.nextIndex();
        })
      })

      function initialize() {
        
        course.listRefresh();

        const startPostion = { lat: course.getList()[0].lat, lng: course.getList()[0].lng };

        course.setMap( 
          new google.maps.Map(document.getElementById("map"), {
            center: startPostion,
            zoom: 14,
          })
        )
        // Set up the markers on the map
        // const cafeMarker = new google.maps.Marker({
        //   position: { lat: 40.730031, lng: -73.991428 },
        //   map,
        //   icon:
        //     "https://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=cafe|FFFF00",
        //   title: "Cafe",
        // });
        // const bankMarker = new google.maps.Marker({
        //   position: { lat: 40.729681, lng: -73.991138 },
        //   map,
        //   icon:
        //     "https://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=dollar|FFFF00",
        //   title: "Bank",
        // });
        // const busMarker = new google.maps.Marker({
        //   position: { lat: 40.729559, lng: -73.990741 },
        //   map,
        //   icon:
        //     "https://chart.apis.google.com/chart?chst=d_map_pin_icon&chld=bus|FFFF00",
        //   title: "Bus Stop",
        // });
        // We get the map's default panorama and set up some defaults.
        // Note that we don't yet set it visible.
        course.setPanorama(
          new google.maps.StreetViewPanorama(
            document.getElementById("pano"),
            {
              position: startPostion,
              pov: {
                heading: 34,
                pitch: 10,
              },
            }
          )
        )
        course.getMap().setStreetView(course.getPanorama());
        
      }
    </script>
  </head>
  <body>
    <div id="map"></div>
    <div id="sidetab">
      <div id="course_title">
        <%= data.course_title %>
      </div>
      <div id="course_list">
        <!-- <% data.course_list.forEach(function(val){ %> 
          <li>
            <div id="course_list_item_img">
              <svg width="18" height="40" viewBox="0 0 18 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="group">
                <line id="bottom_line" x1="9" y1="20" x2="9" y2="40" stroke="#979797" stroke-width="2"/>
                <line id="top_line" x1="9" x2="9" y2="20" stroke="#979797" stroke-width="2"/>
                <circle id="outer_ellipse" r="9" transform="matrix(-1 0 0 1 9 20)" fill="#979797"/>
                <circle id="inner_ellipse" r="7" transform="matrix(-1 0 0 1 9 20)" fill="#A4FF8D"/>
                </g>
              </svg>
            </div>
            <div id="course_list_item_name"><%= val.courseItemName %></div>
          </li> 
        <% }) %> -->
      </div>
    </div>
    <div id="pano"></div>
    <div id="next_course">다음 코스로</div>
    <div id="course_finish" class="hidden">코스 끝내기</div>
  </body>
</html>